import{S as x,i as ee,s as te,e as W,k as re,K as se,c as U,d as M,m as ne,a as ae,b as I,J as ie,g as $,n as Y,w as oe,M as he}from"../chunks/index-d1583acf.js";import{p as K,g as le,b as de,a as ce,c as ue}from"../chunks/index-82dac624.js";function fe(o,n){n===void 0&&(n={});var s=Number(o[0]),c=Number(o[1]),d=Number(o[2]),v=Number(o[3]);if(o.length===6)throw new Error("@turf/bbox-polygon does not support BBox with 6 positions");var p=[s,c],u=[s,v],e=[d,v],t=[d,c];return K([[p,t,e,u,p]],n.properties,{bbox:o,id:n.id})}var H=6378137;function ve(o){return le(o,function(n,s){return n+me(s)},0)}function me(o){var n=0,s;switch(o.type){case"Polygon":return X(o.coordinates);case"MultiPolygon":for(s=0;s<o.coordinates.length;s++)n+=X(o.coordinates[s]);return n;case"Point":case"MultiPoint":case"LineString":case"MultiLineString":return 0}return 0}function X(o){var n=0;if(o&&o.length>0){n+=Math.abs(F(o[0]));for(var s=1;s<o.length;s++)n-=Math.abs(F(o[s]))}return n}function F(o){var n,s,c,d,v,p,u,e=0,t=o.length;if(t>2){for(u=0;u<t;u++)u===t-2?(d=t-2,v=t-1,p=0):u===t-1?(d=t-1,v=0,p=1):(d=u,v=u+1,p=u+2),n=o[d],s=o[v],c=o[p],e+=(q(c[0])-q(n[0]))*Math.sin(q(s[1]));e=e*H*H/2}return e}function q(o){return o*Math.PI/180}var z="0123456789bcdefghjkmnpqrstuvwxyz",J={};for(var N=0;N<z.length;N++)J[z.charAt(N)]=N;var Q="auto",L=-90,E=90,_=-180,k=180,ge=[0,5,7,8,11,12,13,15,16,17,18],T=function(o,n,s){if(s===Q){if(typeof o=="number"||typeof n=="number")throw new Error("string notation required for auto precision.");var c=o.split(".")[1].length,d=n.split(".")[1].length,v=Math.max(c,d);s=ge[v]}else s===void 0&&(s=9);for(var p=[],u=0,e=0,t=0,r=E,h=L,f=k,m=_,l;p.length<s;)if(e%2===0?(l=(f+m)/2,n>l?(t=(t<<1)+1,m=l):(t=(t<<1)+0,f=l)):(l=(r+h)/2,o>l?(t=(t<<1)+1,h=l):(t=(t<<1)+0,r=l)),u++,e++,u===5){var i=z[t];p.push(i),u=0,t=0}return p.join("")},b=function(o,n,s){s=s||52;for(var c=0,d=E,v=L,p=k,u=_,e,t=0;c<s;)t*=2,c%2===0?(e=(p+u)/2,n>e?(t+=1,u=e):p=e):(e=(d+v)/2,o>e?(t+=1,v=e):d=e),c++;return t},G=function(o){for(var n=!0,s=E,c=L,d=k,v=_,p,u=0,e=0,t=o.length;e<t;e++){var r=o[e].toLowerCase();u=J[r];for(var h=4;h>=0;h--){var f=u>>h&1;n?(p=(d+v)/2,f===1?v=p:d=p):(p=(s+c)/2,f===1?c=p:s=p),n=!n}}return[c,v,s,d]},A=function(o,n){n=n||52;for(var s=E,c=L,d=k,v=_,p=0,u=0,e=n/2,t=0;t<e;t++)u=V(o,(e-t)*2-1),p=V(o,(e-t)*2-2),p===0?s=(s+c)/2:c=(s+c)/2,u===0?d=(d+v)/2:v=(d+v)/2;return[c,v,s,d]};function V(o,n){return o/Math.pow(2,n)&1}var R=function(o){var n=G(o),s=(n[0]+n[2])/2,c=(n[1]+n[3])/2,d=n[2]-s,v=n[3]-c;return{latitude:s,longitude:c,error:{latitude:d,longitude:v}}},j=function(o,n){var s=A(o,n),c=(s[0]+s[2])/2,d=(s[1]+s[3])/2,v=s[2]-c,p=s[3]-d;return{latitude:c,longitude:d,error:{latitude:v,longitude:p}}},D=function(o,n){var s=R(o),c=s.latitude+n[0]*s.error.latitude*2,d=s.longitude+n[1]*s.error.longitude*2;return d=C(d),c=O(c),T(c,d,o.length)},Z=function(o,n,s){s=s||52;var c=j(o,s),d=c.latitude+n[0]*c.error.latitude*2,v=c.longitude+n[1]*c.error.longitude*2;return v=C(v),d=O(d),b(d,v,s)},pe=function(o){var n=o.length,s=R(o),c=s.latitude,d=s.longitude,v=s.error.latitude*2,p=s.error.longitude*2,u,e,t=[r(1,0),r(1,1),r(0,1),r(-1,1),r(-1,0),r(-1,-1),r(0,-1),r(1,-1)];function r(h,f){return u=c+h*v,e=d+f*p,e=C(e),u=O(u),T(u,e,n)}return t},ye=function(o,n){n=n||52;var s=j(o,n),c=s.latitude,d=s.longitude,v=s.error.latitude*2,p=s.error.longitude*2,u,e,t=[r(1,0),r(1,1),r(0,1),r(-1,1),r(-1,0),r(-1,-1),r(0,-1),r(1,-1)];function r(h,f){return u=c+h*v,e=d+f*p,e=C(e),u=O(u),b(u,e,n)}return t},we=function(o,n,s,c,d){d=d||9;for(var v=T(o,n,d),p=T(s,c,d),u=R(v),e=u.error.latitude*2,t=u.error.longitude*2,r=G(v),h=G(p),f=Math.round((h[0]-r[0])/e),m=Math.round((h[1]-r[1])/t),l=[],i=0;i<=f;i++)for(var a=0;a<=m;a++)l.push(D(v,[i,a]));return l},ke=function(o,n,s,c,d){d=d||52;for(var v=b(o,n,d),p=b(s,c,d),u=j(v,d),e=u.error.latitude*2,t=u.error.longitude*2,r=A(v,d),h=A(p,d),f=Math.round((h[0]-r[0])/e),m=Math.round((h[1]-r[1])/t),l=[],i=0;i<=f;i++)for(var a=0;a<=m;a++)l.push(Z(v,[i,a],d));return l};function C(o){return o>k?_+o%k:o<_?k+o%k:o}function O(o){return o>E?E:o<L?L:o}var Se={ENCODE_AUTO:Q,encode:T,encode_uint64:b,encode_int:b,decode:R,decode_int:j,decode_uint64:j,decode_bbox:G,decode_bbox_uint64:A,decode_bbox_int:A,neighbor:D,neighbor_int:Z,neighbors:pe,neighbors_int:ye,bboxes:we,bboxes_int:ke},S=Se;const{document:B}=he;function Le(o){let n,s,c;return{c(){n=W("meta"),s=re(),c=W("canvas"),this.h()},l(d){const v=se('[data-svelte="svelte-t32ptj"]',B.head);n=U(v,"META",{name:!0,content:!0}),v.forEach(M),s=ne(d),c=U(d,"CANVAS",{id:!0,class:!0}),ae(c).forEach(M),this.h()},h(){B.title="Home",I(n,"name","description"),I(n,"content","Svelte demo app"),I(c,"id","mapid"),I(c,"class","svelte-1qflwlq")},m(d,v){ie(B.head,n),$(d,s,v),$(d,c,v)},p:Y,i:Y,o:Y,d(d){M(n),d&&M(s),d&&M(c)}}}const Pe=!0;function Ee(o){let n;class s{constructor(e){this.name=e}preRender(){this.clashes=0,this.elements=0,this.renderPerf=0,this.drawn={}}renderArray(){}}class c extends s{constructor(e){super("mml"),this.hash2idarr={},this.id2obj={},this.map=e,e.registerCanvas(this)}load(e,t){const r="api-key=468d361d-0f46-4cde-b8af-9c125302d6d4",h=this;for(const f of e){const m=f+t;if(this.hash2idarr[m]!==void 0)continue;this.hash2idarr[m]===void 0&&(this.hash2idarr[m]=[]);const l=S.decode_bbox(f),i=[l[1],l[0],l[3],l[2]];fetch(`https://avoin-paikkatieto.maanmittauslaitos.fi/maastotiedot/features/v1/collections/${t}/items?${r}&bbox=${i.join(",")}&&bbox-crs=http://www.opengis.net/def/crs/EPSG/0/4326&crs=http://www.opengis.net/def/crs/EPSG/0/4326&f=json`).then(g=>{g.json().then(y=>{for(const w of y.features){const P=w.id;h.hash2idarr[m].push(P),h.id2obj[P]=w}this.map.rerender()})})}}*render(e,t,r,h,f,m){const l=S.bboxes(t[0],t[1],t[2],t[3],f);this.load(l,h),t[3]-t[1],t[2]-t[0];const i={};for(const a of l){const g=a+h;for(const y of this.hash2idarr[g]||[]){const w=this.id2obj[y];if(i[w.id]){this.clashes++;continue}else i[w.id]=!0;this.elements++,yield w}}}renderOne(e,t,r,h,f,m,l,i){if(h=="jarvi"){e.beginPath();for(let a=0;a<i.geometry.coordinates[0].length;a++){const g=i.geometry.coordinates[0][a],y=(g[0]-t[1])/m*r[0],w=r[1]-(g[1]-t[0])/l*r[1];a==0?e.moveTo(y,w):e.lineTo(y,w)}e.closePath(),e.fillStyle="blue",e.fill()}if(h=="korkeuskayra"&&f!=20^i.properties.korkeusarvo%2e4==0){for(let a=0;a<i.geometry.coordinates.length;a++){const g=i.geometry.coordinates[a],y=(g[0]-t[1])/m*r[0],w=r[1]-(g[1]-t[0])/l*r[1];a==0?e.moveTo(y,w):e.lineTo(y,w)}e.lineWidth=.4,e.strokeStyle="white",e.stroke()}if(h=="paikannimi"){const a=i.geometry.coordinates,g=(a[0]-t[1])/m*r[0],y=r[1]-(a[1]-t[0])/l*r[1];e.font="25px arial",e.fillStyle="black",e.textAlign="center",e.fillText(i.properties.teksti,g,y)}if(h=="jyrkanne"){console.log(i);for(let a=0;a<i.geometry.coordinates.length;a++){const g=i.geometry.coordinates[a],y=(g[0]-t[1])/m*r[0],w=r[1]-(g[1]-t[0])/l*r[1];a==0?e.moveTo(y,w):e.lineTo(y,w)}e.lineWidth=5.5,e.strokeStyle="black",e.stroke()}}}class d extends s{constructor(e){super("smk"),this.hash2idarr={},this.id2obj={},this.map=e,e.registerCanvas(this)}load(e){const t=this;for(const r of e){if(this.hash2idarr[r]!==void 0)continue;this.hash2idarr[r]===void 0&&(this.hash2idarr[r]=[]);const h=S.decode_bbox(r);fetch(`https://rajapinnat.metsaan.fi/geoserver/Avoinmetsatieto/stand/wfs?SERVICE=WFS&REQUEST=GetFeature&VERSION=2.0.0&TYPENAMES=Avoinmetsatieto:stand&STARTINDEX=0&COUNT=10000&SRSNAME=urn:ogc:def:crs:EPSG::4326&BBOX=${h.join(",")},urn:ogc:def:crs:EPSG::4326&outputFormat=json`).then(m=>{m.json().then(l=>{for(const i of l.features){const a=i.id;t.hash2idarr[r].push(a),t.id2obj[a]=i,this.addTrees(i)}this.map.rerender()})})}}*render(e,t,r,h,f,m){const l=S.bboxes(t[0],t[1],t[2],t[3],f);this.load(l),t[3]-t[1],t[2]-t[0];const i={};for(const a of l)for(const g of this.hash2idarr[a]||[]){const y=this.id2obj[g];if(i[y.id]){this.clashes++;continue}else i[y.id]=!0;this.elements++,yield y}}renderOne(e,t,r,h,f,m,l,i){const a=i.properties;if(h=="ground"){e.beginPath();for(let g=0;g<i.geometry.coordinates[0].length;g++){const y=i.geometry.coordinates[0][g],w=(y[0]-t[1])/m*r[0],P=r[1]-(y[1]-t[0])/l*r[1];g==0?e.moveTo(w,P):e.lineTo(w,P)}e.closePath(),this.renderSoil(e,a.MAINGROUP,a.SUBGROUP,a.SOILTYPE,!1)}h=="trees"&&this.renderTrees(e,t,r,i.trees)}renderSoil(e,t,r,h,f){switch(e.fillStyle="magenta",t){case 1:switch(e.fillStyle="LimeGreen",r){case 1:e.fillStyle="LimeGreen";break;case 2:e.fillStyle="MediumSeaGreen";break;case 3:e.fillStyle="DarkSeaGreen";break;case 4:e.fillStyle="YellowGreen";break;case 5:e.fillStyle="DarkKhaki";break}break;case 2:e.fillStyle="orange";break;case 3:e.fillStyle="brown";break;case 4:break;case 5:break;case 6:e.fillStyle="yellow";break;case 7:break;case 8:e.fillStyle="blue";break}switch(f&&(e.fillStyle="yellow"),r){case 1:e.fillStyle="LimeGreen";break;case 2:e.fillStyle="#9ABD53";break;case 3:e.fillStyle="YellowGreen";break;case 4:e.fillStyle="Gold";break;case 5:e.fillStyle="Aquamarine";break}e.fill(),e.strokeStyle="grey",e.lineWidth=.3,e.stroke()}addTrees(e){if(e.trees)return;const t=.016,r=.013;e.trees=[];const h=e.properties,f=K(e.geometry.coordinates,e.properties),m=de(f);let l=h.STEMCOUNT>0?Math.sqrt(h.AREA/h.STEMCOUNT):1e4;h.STEMCOUNT&&(l*=ve(fe(m))/1e4/h.AREA),e.freq=l;let i={x:m[1],y:m[2]};for(;i.y>m[0];){const a=ce([i.y,i.x]);ue(a,f)&&e.trees.push({pt:a.geometry.coordinates,height:h.MEANHEIGHT,specie:h.MAINTREESPECIES}),i.x+=l*t,i.x>m[3]&&(i.y-=l*r,i.x-=m[3]-[m[1]])}}renderTrees(e,t,r,h){const f=t[3]-t[1],m=t[2]-t[0];for(const l of h){const i=l.pt,a=(i[0]-t[1])/f*r[0],g=r[1]-(i[1]-t[0])/m*r[1];switch(e.beginPath(),e.moveTo(a-Math.max(l.height/7,1),g),e.lineTo(a,g-Math.max(l.height,3)),e.lineTo(a+Math.max(l.height/7,1),g),e.closePath(),e.fillStyle="brown",e.fill(),l.specie){case 1:e.beginPath(),e.arc(a,g-l.height*.7,l.height/2,Math.PI*.8,Math.PI*.2),e.closePath(),e.fillStyle="ForestGreen",e.fill();break;case 2:e.beginPath(),e.moveTo(a-l.height/3,g-2),e.lineTo(a,g-l.height),e.lineTo(a+l.height/3,g-2),e.closePath(),e.fillStyle="ForestGreen",e.fill();break;case 3:case 4:e.fillStyle="LightYellow",e.fill(),e.beginPath(),e.arc(a,g-l.height*1,l.height/3,Math.PI*.85,Math.PI*.15),e.arc(a,g-l.height*.6,l.height/2.5,Math.PI*.85,Math.PI*.15),e.closePath(),e.fillStyle="GreenYellow",e.fill();break;case 5:case 29:e.fillStyle="DarkGray",e.fill(),e.beginPath(),e.arc(a,g-l.height*1,l.height/3,Math.PI*.85,Math.PI*.15),e.arc(a,g-l.height*.6,l.height/2.5,Math.PI*.85,Math.PI*.15),e.closePath(),e.fillStyle="DarkGreen",e.fill();break}}}}class v extends s{constructor(e){super("osm"),this.hash2idarr={},this.id2obj={},this.map=e,e.registerCanvas(this)}load(e,t){const r="https://overpass.kumi.systems/api/interpreter",h=this;for(const f of e){if(this.hash2idarr[f]!==void 0)continue;this.hash2idarr[f]===void 0&&(this.hash2idarr[f]=[]);const m=S.decode_bbox(f),l=t=="motorway"?'[highway="motorway"]':'[highway][highway!="motorway"]';fetch(`${r}?data=[out:json][bbox:${m.join(",")}];way${l};out geom;`).then(i=>{i.json().then(a=>{a.elements.length==0&&(h.hash2idarr[f]=[]);for(const g of a.elements){const y=g.id;h.hash2idarr[f].push(y),h.id2obj[y]=g}this.map.rerender()})}).catch(i=>{this.hash2idarr[f]=void 0,this.map.rerender()})}}*render(e,t,r,h,f,m){const l=S.bboxes(t[0],t[1],t[2],t[3],f);this.load(l,h),t[3]-t[1],t[2]-t[0];const i={};for(const a of l)for(const g of this.hash2idarr[a]||[]){const y=this.id2obj[g];if(i[y.id]){this.clashes++;continue}else i[y.id]=!0;this.elements++,yield y}}renderOne(e,t,r,h,f,m,l,i){e.beginPath();for(let a=0;a<i.geometry.length;a++){const g=i.geometry[a],y=(g.lon-t[1])/m*r[0],w=r[1]-(g.lat-t[0])/l*r[1];a==0?e.moveTo(y,w):e.lineTo(y,w)}if(i.tags.highway=="path"){if(i.tags["mtb:scale"]){let a=null;switch(parseInt(i.tags["mtb:scale"])){case 1:a="lime";break;case 2:a="yellow";break;case 3:a="orange";break;case 4:a="red";break;case 5:a="purple";break;case 6:a="purple";break}e.setLineDash([]),e.lineWidth=6,e.strokeStyle=a,e.stroke()}e.setLineDash([15,5]),e.lineWidth=2,e.strokeStyle="black",e.stroke()}else e.setLineDash([]),e.lineWidth=3,e.strokeStyle="black",e.stroke();e.setLineDash([])}}class p{constructor(e){const r=Math.atan(15696123057604772e-23);this.meterAngle=r;const f=96/2.54;this.ppcm=f;const m={pos:[62.211451,25.691848],zoom:1/5e3,rot:0};this.view=m,this.canvas=e,this.ctx=e.getContext("2d"),e.style.backgroundColor="grey",this.canvases=[],this.bindEvents(e),this.rStarted=!1,this.rEnded=!1,this.cleanRenderNeeded=!0,this.rLayoutIdx=-1}setLayout(e){this.layouts=e}registerCanvas(e){this.canvases.push(e)}render(){const e=window.performance.now();for(const i of this.canvases)i.preRender();this.cleanRenderNeeded&&(this.ctx.clearRect(0,0,this.canvas.width,this.canvas.height),this.cleanRenderNeeded=!1,this.rLayoutIdx=-1,this.rStarted=!0,this.rEnded=!1,this.rgen=void 0);const t=this.canvas.width/this.ppcm/2/this.view.zoom*this.meterAngle,r=this.canvas.height/this.ppcm/4/this.view.zoom*this.meterAngle,h=[-r+this.view.pos[0],-t+this.view.pos[1],r+this.view.pos[0],t+this.view.pos[1]],f=[this.canvas.width,this.canvas.height],m=h[3]-h[1],l=h[2]-h[0];for(this.rLayoutIdx<0&&(this.rLayoutIdx=this.layouts.length-1);this.rLayoutIdx>=0;){const i=this.layouts[this.rLayoutIdx];if(i.max<this.view.zoom&&this.view.zoom<i.min){window.performance.now(),this.ctx.save(),this.ctx.beginPath(),this.rgen==null&&(this.rgen=i.obj.render(this.ctx,h,f,i.feature,i.hashlen||6,i.extra));let a;for(;!(a=this.rgen.next()).done;){const g=a.value;if(i.obj.renderOne(this.ctx,h,f,i.feature,i.extra,m,l,g),window.performance.now()-e>2)break}if(this.ctx.restore(),a.done)this.rgen=void 0,this.rLayoutIdx--;else{window.requestAnimationFrame(this.render.bind(this));break}}}this.rLayoutIdx==-1&&(this.rEnded=!0)}rerender(){this.cleanRenderNeeded=!0,window.requestAnimationFrame(this.render.bind(this))}bindEvents(e){e.addEventListener("wheel",t=>{t.preventDefault();const r=this.getPos(t.offsetX,t.offsetY);t.deltaY<0&&(this.view.zoom*=1+-t.deltaY*.01),t.deltaY>0&&(this.view.zoom/=1+t.deltaY*.01);const h=this.getPos(t.offsetX,t.offsetY);this.view.pos[0]+=h[0]-r[0],this.view.pos[1]+=h[1]-r[1],this.rerender()}),e.addEventListener("mousedown",t=>{this.startEvent={x:t.offsetX,y:t.offsetY,p:Array.from(this.view.pos)}}),e.addEventListener("mousemove",t=>{if(this.startEvent){const r=this.startEvent.x-t.offsetX,h=this.startEvent.y-t.offsetY,f=r/this.ppcm/this.view.zoom*this.meterAngle,m=h/this.ppcm/this.view.zoom*this.meterAngle/2;this.view.pos=Array.from(this.startEvent.p),this.view.pos[0]-=m,this.view.pos[1]+=f,this.rerender()}}),e.addEventListener("mouseup",t=>{this.startEvent=void 0}),e.addEventListener("touchstart",t=>{console.log(t)}),e.addEventListener("touchmove",t=>{console.log(t)}),e.addEventListener("touchend",t=>{console.log(t)})}getPos(e,t){const r=e-this.canvas.width/2,h=t-this.canvas.height/2,f=r/this.ppcm/this.view.zoom*this.meterAngle,m=h/this.ppcm/this.view.zoom*this.meterAngle/2;return[this.view.pos[0]+m,this.view.pos[1]-f]}x(e,t){const r=e[3]-e[1];return(t-e[1])/r*this.canvas.width}y(e,t){const r=e[2]-e[0];return this.canvas.height-(t-e[0])/r*this.canvas.height}}return oe(async()=>{console.log(window.devicePixelRatio);const u=document.getElementById("mapid");u.height=u.offsetHeight,u.width=u.offsetWidth,u.getContext("2d"),n=new p(u);const e=new v(n),t=new d(n),r=new c(n);n.setLayout([{name:"puut",max:1/1e5,min:1,obj:t,feature:"trees"},{name:"polut",max:1/6e4,min:1,obj:e},{name:"jyrk\xE4nteet",max:1/25e3,min:1,obj:r,feature:"jyrkanne"},{name:"korkeusk\xE4yr\xE4t",max:1/4e3,min:1,obj:r,feature:"korkeuskayra"},{name:"korkeusk\xE4yr\xE4t20",max:1/1e4,min:1,obj:r,feature:"korkeuskayra",extra:20},{name:"nimet",hashlen:4,max:0,min:1,obj:r,feature:"paikannimi"},{name:"mets\xE4pohja",hashlen:6,max:1/5e4,min:1,obj:t,feature:"ground"},{name:"j\xE4rvet",hashlen:6,max:1/5e5,min:1,obj:r,feature:"jarvi"}]),n.render(),setTimeout(()=>{console.log("a")},3*1e3)}),[]}class Me extends x{constructor(n){super(),ee(this,n,Ee,Le,te,{})}}export{Me as default,Pe as prerender};
