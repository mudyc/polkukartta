import{S as K,i as D,s as J,e as B,k as Q,K as Z,c as z,d as P,m as x,a as ee,b as I,J as te,g as $,n as W,w as se,M as re}from"../chunks/index-d1583acf.js";import{p as ie,b as ae,a as oe,c as ne}from"../chunks/index-84de4434.js";var q="0123456789bcdefghjkmnpqrstuvwxyz",U={};for(var N=0;N<q.length;N++)U[q.charAt(N)]=N;var X="auto",_=-90,E=90,b=-180,w=180,he=[0,5,7,8,11,12,13,15,16,17,18],j=function(u,h,n){if(n===X){if(typeof u=="number"||typeof h=="number")throw new Error("string notation required for auto precision.");var m=u.split(".")[1].length,l=h.split(".")[1].length,g=Math.max(m,l);n=he[g]}else n===void 0&&(n=9);for(var k=[],v=0,e=0,t=0,s=E,i=_,c=w,f=b,o;k.length<n;)if(e%2===0?(o=(c+f)/2,h>o?(t=(t<<1)+1,f=o):(t=(t<<1)+0,c=o)):(o=(s+i)/2,u>o?(t=(t<<1)+1,i=o):(t=(t<<1)+0,s=o)),v++,e++,v===5){var a=q[t];k.push(a),v=0,t=0}return k.join("")},T=function(u,h,n){n=n||52;for(var m=0,l=E,g=_,k=w,v=b,e,t=0;m<n;)t*=2,m%2===0?(e=(k+v)/2,h>e?(t+=1,v=e):k=e):(e=(l+g)/2,u>e?(t+=1,g=e):l=e),m++;return t},G=function(u){for(var h=!0,n=E,m=_,l=w,g=b,k,v=0,e=0,t=u.length;e<t;e++){var s=u[e].toLowerCase();v=U[s];for(var i=4;i>=0;i--){var c=v>>i&1;h?(k=(l+g)/2,c===1?g=k:l=k):(k=(n+m)/2,c===1?m=k:n=k),h=!h}}return[m,g,n,l]},A=function(u,h){h=h||52;for(var n=E,m=_,l=w,g=b,k=0,v=0,e=h/2,t=0;t<e;t++)v=H(u,(e-t)*2-1),k=H(u,(e-t)*2-2),k===0?n=(n+m)/2:m=(n+m)/2,v===0?l=(l+g)/2:g=(l+g)/2;return[m,g,n,l]};function H(u,h){return u/Math.pow(2,h)&1}var R=function(u){var h=G(u),n=(h[0]+h[2])/2,m=(h[1]+h[3])/2,l=h[2]-n,g=h[3]-m;return{latitude:n,longitude:m,error:{latitude:l,longitude:g}}},M=function(u,h){var n=A(u,h),m=(n[0]+n[2])/2,l=(n[1]+n[3])/2,g=n[2]-m,k=n[3]-l;return{latitude:m,longitude:l,error:{latitude:g,longitude:k}}},F=function(u,h){var n=R(u),m=n.latitude+h[0]*n.error.latitude*2,l=n.longitude+h[1]*n.error.longitude*2;return l=C(l),m=O(m),j(m,l,u.length)},V=function(u,h,n){n=n||52;var m=M(u,n),l=m.latitude+h[0]*m.error.latitude*2,g=m.longitude+h[1]*m.error.longitude*2;return g=C(g),l=O(l),T(l,g,n)},le=function(u){var h=u.length,n=R(u),m=n.latitude,l=n.longitude,g=n.error.latitude*2,k=n.error.longitude*2,v,e,t=[s(1,0),s(1,1),s(0,1),s(-1,1),s(-1,0),s(-1,-1),s(0,-1),s(1,-1)];function s(i,c){return v=m+i*g,e=l+c*k,e=C(e),v=O(v),j(v,e,h)}return t},de=function(u,h){h=h||52;var n=M(u,h),m=n.latitude,l=n.longitude,g=n.error.latitude*2,k=n.error.longitude*2,v,e,t=[s(1,0),s(1,1),s(0,1),s(-1,1),s(-1,0),s(-1,-1),s(0,-1),s(1,-1)];function s(i,c){return v=m+i*g,e=l+c*k,e=C(e),v=O(v),T(v,e,h)}return t},ce=function(u,h,n,m,l){l=l||9;for(var g=j(u,h,l),k=j(n,m,l),v=R(g),e=v.error.latitude*2,t=v.error.longitude*2,s=G(g),i=G(k),c=Math.round((i[0]-s[0])/e),f=Math.round((i[1]-s[1])/t),o=[],a=0;a<=c;a++)for(var r=0;r<=f;r++)o.push(F(g,[a,r]));return o},fe=function(u,h,n,m,l){l=l||52;for(var g=T(u,h,l),k=T(n,m,l),v=M(g,l),e=v.error.latitude*2,t=v.error.longitude*2,s=A(g,l),i=A(k,l),c=Math.round((i[0]-s[0])/e),f=Math.round((i[1]-s[1])/t),o=[],a=0;a<=c;a++)for(var r=0;r<=f;r++)o.push(V(g,[a,r],l));return o};function C(u){return u>w?b+u%w:u<b?w+u%w:u}function O(u){return u>E?E:u<_?_:u}var me={ENCODE_AUTO:X,encode:j,encode_uint64:T,encode_int:T,decode:R,decode_int:M,decode_uint64:M,decode_bbox:G,decode_bbox_uint64:A,decode_bbox_int:A,neighbor:F,neighbor_int:V,neighbors:le,neighbors_int:de,bboxes:ce,bboxes_int:fe},L=me;const{document:Y}=re;function ue(u){let h,n,m;return{c(){h=B("meta"),n=Q(),m=B("canvas"),this.h()},l(l){const g=Z('[data-svelte="svelte-t32ptj"]',Y.head);h=z(g,"META",{name:!0,content:!0}),g.forEach(P),n=x(l),m=z(l,"CANVAS",{id:!0,class:!0}),ee(m).forEach(P),this.h()},h(){Y.title="Home",I(h,"name","description"),I(h,"content","Svelte demo app"),I(m,"id","mapid"),I(m,"class","svelte-1qflwlq")},m(l,g){te(Y.head,h),$(l,n,g),$(l,m,g)},p:W,i:W,o:W,d(l){P(h),l&&P(n),l&&P(m)}}}const ye=!0;function ge(u){let h;class n{constructor(e){this.name=e}preRender(){this.clashes=0,this.elements=0,this.renderPerf=0,this.drawn={}}renderArray(){}}class m extends n{constructor(e){super("mml"),this.hash2idarr={},this.id2obj={},this.map=e,e.registerCanvas(this)}load(e,t){const s="api-key=468d361d-0f46-4cde-b8af-9c125302d6d4",i=this;for(const c of e){const f=c+t;if(this.hash2idarr[f]!==void 0)continue;this.hash2idarr[f]===void 0&&(this.hash2idarr[f]=[]);const o=L.decode_bbox(c),a=[o[1],o[0],o[3],o[2]];fetch(`https://avoin-paikkatieto.maanmittauslaitos.fi/maastotiedot/features/v1/collections/${t}/items?${s}&bbox=${a.join(",")}&&bbox-crs=http://www.opengis.net/def/crs/EPSG/0/4326&crs=http://www.opengis.net/def/crs/EPSG/0/4326&f=json`).then(d=>{d.json().then(p=>{for(const y of p.features){const S=y.id;i.hash2idarr[f].push(S),i.id2obj[S]=y}this.map.rerender()})})}}*render(e,t,s,i,c,f){const o=L.bboxes(t[0],t[1],t[2],t[3],c);this.load(o,i),t[3]-t[1],t[2]-t[0];const a={};for(const r of o){const d=r+i;for(const p of this.hash2idarr[d]||[]){const y=this.id2obj[p];if(a[y.id]){this.clashes++;continue}else a[y.id]=!0;this.elements++,yield y}}}renderOne(e,t,s,i,c,f,o,a){if(i=="jarvi"){e.beginPath();for(let r=0;r<a.geometry.coordinates[0].length;r++){const d=a.geometry.coordinates[0][r],p=(d[0]-t[1])/f*s[0],y=s[1]-(d[1]-t[0])/o*s[1];r==0?e.moveTo(p,y):e.lineTo(p,y)}e.closePath(),e.fillStyle="#1e90ff",e.fill()}if(i=="korkeuskayra"&&c!=20^a.properties.korkeusarvo%2e4==0){for(let r=0;r<a.geometry.coordinates.length;r++){const d=a.geometry.coordinates[r],p=(d[0]-t[1])/f*s[0],y=s[1]-(d[1]-t[0])/o*s[1];r==0?e.moveTo(p,y):e.lineTo(p,y)}e.lineWidth=.4,e.strokeStyle="#87a96b",e.stroke()}if(i=="paikannimi"){const r=a.geometry.coordinates,d=(r[0]-t[1])/f*s[0],p=s[1]-(r[1]-t[0])/o*s[1];e.font="25px arial",e.fillStyle="black",e.textAlign="center",e.fillText(a.properties.teksti,d,p)}if(i=="jyrkanne"){for(let r=0;r<a.geometry.coordinates.length;r++){const d=a.geometry.coordinates[r],p=(d[0]-t[1])/f*s[0],y=s[1]-(d[1]-t[0])/o*s[1];r==0?e.moveTo(p,y):e.lineTo(p,y)}e.lineWidth=5.5,e.strokeStyle="black",e.stroke()}if(i=="virtavesikapea"){for(let r=0;r<a.geometry.coordinates.length;r++){const d=a.geometry.coordinates[r],p=(d[0]-t[1])/f*s[0],y=s[1]-(d[1]-t[0])/o*s[1];r==0?e.moveTo(p,y):e.lineTo(p,y)}e.lineWidth=1,e.strokeStyle="blue",e.stroke()}if(i=="suo"){e.beginPath();for(let r=0;r<a.geometry.coordinates[0].length;r++){const d=a.geometry.coordinates[0][r],p=(d[0]-t[1])/f*s[0],y=s[1]-(d[1]-t[0])/o*s[1];r==0?e.moveTo(p,y):e.lineTo(p,y)}e.closePath(),e.fillStyle="rgb(0,0,255, 0.10)",e.fill()}}}class l extends n{constructor(e){super("smk"),this.hash2idarr={},this.id2obj={},this.map=e,e.registerCanvas(this)}load(e,t){const s=this;for(const i of e){if(this.hash2idarr[i]!==void 0)continue;this.hash2idarr[i]===void 0&&(this.hash2idarr[i]=[]);const c=L.decode_bbox(i);fetch(`https://rajapinnat.metsaan.fi/geoserver/Avoinmetsatieto/stand/wfs?SERVICE=WFS&REQUEST=GetFeature&VERSION=2.0.0&TYPENAMES=Avoinmetsatieto:stand&STARTINDEX=0&COUNT=10000&SRSNAME=urn:ogc:def:crs:EPSG::4326&BBOX=${c.join(",")},urn:ogc:def:crs:EPSG::4326&outputFormat=json`).then(o=>{o.json().then(a=>{for(const r of a.features){const d=r.id;s.hash2idarr[i].push(d),s.id2obj[d]=r,this.map.addTask(()=>{this.addTrees(r)})}this.map.rerender()})})}}*render(e,t,s,i,c,f){const o=L.bboxes(t[0],t[1],t[2],t[3],c);this.load(o,i),t[3]-t[1],t[2]-t[0];const a={};for(const r of o)for(const d of this.hash2idarr[r]||[]){const p=this.id2obj[d];if(a[p.id]){this.clashes++;continue}else a[p.id]=!0;this.elements++,yield p}}renderOne(e,t,s,i,c,f,o,a){const r=a.properties;if(i=="ground"){e.beginPath();for(let d=0;d<a.geometry.coordinates[0].length;d++){const p=a.geometry.coordinates[0][d],y=(p[0]-t[1])/f*s[0],S=s[1]-(p[1]-t[0])/o*s[1];d==0?e.moveTo(y,S):e.lineTo(y,S)}e.closePath(),this.renderSoil(e,r.MAINGROUP,r.SUBGROUP,r.SOILTYPE,!1)}i=="trees"&&a.trees&&this.renderTrees(e,t,s,a.trees)}renderSoil(e,t,s,i,c){switch(e.fillStyle="magenta",t){case 1:switch(e.fillStyle="LimeGreen",s){case 1:e.fillStyle="#77dd77";break;case 2:e.fillStyle="MediumSeaGreen";break;case 3:e.fillStyle="DarkSeaGreen";break;case 4:e.fillStyle="YellowGreen";break;case 5:e.fillStyle="DarkKhaki";break}break;case 2:e.fillStyle="orange";break;case 3:e.fillStyle="brown";break;case 4:break;case 5:break;case 6:e.fillStyle="yellow";break;case 7:break;case 8:e.fillStyle="blue";break}switch(c&&(e.fillStyle="yellow"),s){case 1:e.fillStyle="#5BCE5B";break;case 2:e.fillStyle="#9ABD53";break;case 3:e.fillStyle="YellowGreen";break;case 4:e.fillStyle="Gold";break;case 5:e.fillStyle="Aquamarine";break}e.fill(),e.strokeStyle="#76ff7a",e.lineWidth=.3,e.stroke()}addTrees(e){if(e.trees)return;const t=.016,s=.013;e.trees=[];const i=e.properties,c=ie(e.geometry.coordinates,e.properties),f=ae(c);let o=i.STEMCOUNT>0?Math.sqrt(i.AREA/i.STEMCOUNT):1e4;e.freq=o;let a={x:f[1],y:f[2]};for(;a.y>f[0];){const r=oe([a.y,a.x]);ne(r,c)&&e.trees.push({pt:r.geometry.coordinates,height:i.MEANHEIGHT,specie:i.MAINTREESPECIES}),a.x+=o*t,a.x>f[3]&&(a.y-=o*s,a.x-=f[3]-[f[1]])}}renderTrees(e,t,s,i){const c=t[3]-t[1],f=t[2]-t[0];for(const o of i){const a=o.pt,r=(a[0]-t[1])/c*s[0],d=s[1]-(a[1]-t[0])/f*s[1];switch(e.beginPath(),e.moveTo(r-Math.max(o.height/7,1),d),e.lineTo(r,d-Math.max(o.height,3)),e.lineTo(r+Math.max(o.height/7,1),d),e.closePath(),e.fillStyle="brown",e.fill(),o.specie){case 1:e.beginPath(),e.arc(r,d-o.height*.7,o.height/2,Math.PI*.8,Math.PI*.2),e.closePath(),e.fillStyle="ForestGreen",e.fill();break;case 2:e.beginPath(),e.moveTo(r-o.height/3,d-2),e.lineTo(r,d-o.height),e.lineTo(r+o.height/3,d-2),e.closePath(),e.fillStyle="ForestGreen",e.fill();break;case 3:case 4:e.fillStyle="LightYellow",e.fill(),e.beginPath(),e.arc(r,d-o.height*1,o.height/3,Math.PI*.85,Math.PI*.15),e.arc(r,d-o.height*.6,o.height/2.5,Math.PI*.85,Math.PI*.15),e.closePath(),e.fillStyle="GreenYellow",e.fill();break;case 5:case 29:e.fillStyle="DarkGray",e.fill(),e.beginPath(),e.arc(r,d-o.height*1,o.height/3,Math.PI*.85,Math.PI*.15),e.arc(r,d-o.height*.6,o.height/2.5,Math.PI*.85,Math.PI*.15),e.closePath(),e.fillStyle="DarkGreen",e.fill();break}}}}class g extends n{constructor(e){super("osm"),this.hash2idarr={},this.id2obj={},this.id2mark={},this.map=e,e.registerCanvas(this)}load(e,t){const s="https://overpass.kumi.systems/api/interpreter",i=this;for(const c of e){const f=c+t;if(this.hash2idarr[f]!==void 0)continue;this.hash2idarr[f]===void 0&&(this.hash2idarr[f]=[]);const o=L.decode_bbox(c),a=t=="motorway"?'way[highway="motorway"];out geom;':t=="reitti"?'rel[route="hiking"];out;':'way[highway][highway!="motorway"];out geom;';fetch(`${s}?data=[out:json][bbox:${o.join(",")}];${a}`).then(r=>{r.json().then(d=>{d.elements.length==0&&(i.hash2idarr[f]=[]);for(const p of d.elements){const y=p.id;if(i.hash2idarr[f].push(y),p.type=="way")i.id2obj[y]=p;else if(t=="reitti"&&p.type=="relation")for(const S of p.members)i.id2mark[S.ref]=!0}this.map.rerender()})}).catch(r=>{this.hash2idarr[f]=void 0,this.map.rerender()})}}*render(e,t,s,i,c,f){const o=L.bboxes(t[0],t[1],t[2],t[3],c);if(this.load(o,i),i=="reitti")return;t[3]-t[1],t[2]-t[0];const a={};for(const r of o){const d=r+i;for(const p of this.hash2idarr[d]||[]){const y=this.id2obj[p];if(a[y.id]){this.clashes++;continue}else a[y.id]=!0;this.elements++,yield y}}}renderOne(e,t,s,i,c,f,o,a){e.beginPath(),e.beginPath();for(let r=0;r<a.geometry.length;r++){const d=a.geometry[r],p=(d.lon-t[1])/f*s[0],y=s[1]-(d.lat-t[0])/o*s[1];r==0?e.moveTo(p,y):e.lineTo(p,y)}if(this.id2mark[a.id]&&(e.setLineDash([]),e.lineWidth=9,e.strokeStyle="rgb(218,112,214,0.8)",e.stroke()),a.tags.highway=="path"){if(a.tags["mtb:scale"]){let r=null;switch(parseInt(a.tags["mtb:scale"])){case 1:r="lime";break;case 2:r="yellow";break;case 3:r="orange";break;case 4:r="red";break;case 5:r="purple";break;case 6:r="purple";break;default:r="lime"}e.setLineDash([]),e.lineWidth=4,e.strokeStyle=r,e.stroke()}e.setLineDash([15,5]),e.lineWidth=2,e.strokeStyle="black",e.stroke()}else e.setLineDash([]),a.tags.highway=="cycleway"||a.tags.highway=="footway"?(e.lineWidth=4,e.strokeStyle="#bfc1c2",e.stroke()):a.tags.surface=="asphalt"||a.tags.highway=="motorway"||a.tags.highway=="motorway_link"||a.tags.highway=="trunk"||a.tags.highway=="trunk_link"?(e.lineWidth=12,e.strokeStyle="#bfc1c2",e.stroke(),e.setLineDash([6,18]),e.lineWidth=1,e.strokeStyle="white",e.stroke()):(e.lineWidth=8,e.strokeStyle="#a0522d",e.stroke());e.setLineDash([])}}class k{constructor(e){const s=Math.atan(15696123057604772e-23);this.meterAngle=s;const c=96/2.54;this.ppcm=c;const f={pos:[62.252579460535756,25.80582969019064],pos:[62.212492630467814,25.6282595440125],pos:[62.207982056800816,25.712969957941112],zoom:1/5e3,rot:0};this.view=f,this.canvas=e,this.ctx=e.getContext("2d"),e.style.backgroundColor="grey",this.canvases=[],this.bindEvents(e),this.rOngoing=!1,this.cleanRenderNeeded=!0,this.rLayoutIdx=-1,this.tasks=[]}addTask(e){this.tasks.push(e)}setLayout(e){this.layouts=e}registerCanvas(e){this.canvases.push(e)}render(){const e=window.performance.now();for(;this.tasks.length&&(this.tasks.shift()(),!(window.performance.now()-e>.5)););const t=window.performance.now();for(const r of this.canvases)r.preRender();!this.rOngoing&&this.cleanRenderNeeded&&(this.ctx.clearRect(0,0,this.canvas.width,this.canvas.height),this.cleanRenderNeeded=!1,this.rLayoutIdx=-1,this.rOngoing=!0,console.log("clean"));const s=this.canvas.width/this.ppcm/2/this.view.zoom*this.meterAngle,i=this.canvas.height/this.ppcm/4/this.view.zoom*this.meterAngle,c=[-i+this.view.pos[0],-s+this.view.pos[1],i+this.view.pos[0],s+this.view.pos[1]],f=[this.canvas.width,this.canvas.height],o=c[3]-c[1],a=c[2]-c[0];for(this.rLayoutIdx<0&&(this.rLayoutIdx=this.layouts.length-1);this.rLayoutIdx>=0;){const r=this.layouts[this.rLayoutIdx];if(r.max<this.view.zoom&&this.view.zoom<r.min){window.performance.now(),this.ctx.save(),this.ctx.beginPath(),r.rgen==null&&(r.rgen=r.obj.render(this.ctx,c,f,r.feature,r.hashlen||6,r.extra));let d;for(;!(d=r.rgen.next()).done;){const p=d.value;if(r.obj.renderOne(this.ctx,c,f,r.feature,r.extra,o,a,p),window.performance.now()-t>2)break}if(this.ctx.restore(),d.done)r.rgen=void 0,this.rLayoutIdx--;else{window.requestAnimationFrame(this.render.bind(this));break}}else this.rLayoutIdx--}this.rLayoutIdx==-1&&(this.rOngoing=!1)}rerender(){this.cleanRenderNeeded=!0,window.requestAnimationFrame(this.render.bind(this))}bindEvents(e){e.addEventListener("wheel",t=>{t.preventDefault();const s=this.getPos(t.offsetX,t.offsetY);t.deltaY<0&&(this.view.zoom*=1+-t.deltaY*.01),t.deltaY>0&&(this.view.zoom/=1+t.deltaY*.01);const i=this.getPos(t.offsetX,t.offsetY);this.view.pos[0]+=i[0]-s[0],this.view.pos[1]+=i[1]-s[1],this.rerender()}),e.addEventListener("mousedown",t=>{this.startEvent={x:t.offsetX,y:t.offsetY,p:Array.from(this.view.pos)}}),e.addEventListener("mousemove",t=>{if(this.startEvent){const s=this.startEvent.x-t.offsetX,i=this.startEvent.y-t.offsetY,c=s/this.ppcm/this.view.zoom*this.meterAngle,f=i/this.ppcm/this.view.zoom*this.meterAngle/2;this.view.pos=Array.from(this.startEvent.p),this.view.pos[0]-=f,this.view.pos[1]+=c,this.rerender()}}),e.addEventListener("mouseup",t=>{this.startEvent=void 0,console.log(this.view.pos)}),e.addEventListener("touchstart",t=>{console.log(t)}),e.addEventListener("touchmove",t=>{console.log(t)}),e.addEventListener("touchend",t=>{console.log(t)})}getPos(e,t){const s=e-this.canvas.width/2,i=t-this.canvas.height/2,c=s/this.ppcm/this.view.zoom*this.meterAngle,f=i/this.ppcm/this.view.zoom*this.meterAngle/2;return[this.view.pos[0]+f,this.view.pos[1]-c]}x(e,t){const s=e[3]-e[1];return(t-e[1])/s*this.canvas.width}y(e,t){const s=e[2]-e[0];return this.canvas.height-(t-e[0])/s*this.canvas.height}}return se(async()=>{console.log(window.devicePixelRatio);const v=document.getElementById("mapid");v.height=v.offsetHeight,v.width=v.offsetWidth,v.getContext("2d"),h=new k(v);const e=new g(h),t=new l(h),s=new m(h);h.setLayout([{name:"polut",max:1/6e4,min:1,obj:e,feature:"polut",hashlen:6},{name:"puut",max:1/9e3,min:1,obj:t,feature:"trees"},{name:"reitit",max:1/6e4,min:1,obj:e,feature:"reitti",hashlen:6},{name:"jyrk\xE4nteet",max:1/25e3,min:1,obj:s,feature:"jyrkanne"},{name:"korkeusk\xE4yr\xE4t",max:1/1e4,min:1,obj:s,feature:"korkeuskayra"},{name:"korkeusk\xE4yr\xE4t20",max:1/3e4,min:1,obj:s,feature:"korkeuskayra",extra:20},{name:"nimet",hashlen:4,max:0,min:1,obj:s,feature:"paikannimi"},{name:"ojat",max:1/1e4,min:1,obj:s,feature:"virtavesikapea"},{name:"suot",hashlen:6,max:1/5e4,min:1,obj:s,feature:"suo"},{name:"mets\xE4pohja",hashlen:6,max:1/5e4,min:1,obj:t,feature:"ground"},{name:"j\xE4rvet",hashlen:6,max:1/5e5,min:1,obj:s,feature:"jarvi"},{name:"isot tiet",hashlen:4,max:0,min:1,obj:e,feature:"motorway"}]),h.render(),setTimeout(()=>{console.log("a")},3*1e3)}),[]}class ke extends K{constructor(h){super(),D(this,h,ge,ue,J,{})}}export{ke as default,ye as prerender};
